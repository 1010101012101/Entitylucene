Mountain Lion VPN fails to connect but works on Windows VM <body> I want to setup a VPN on my mac but I can't make it work. If I start my Windows 7 VM, the VPN connects fine (from Windows) but if I try to connect from my Mac it fails…  First of all, here is the system log:  precodeOct  7 15:18:45 Leonardo-Ferreiras-iMac.local configd[18]: SCNC: start, triggered by System Preferen, type L2TP, status 0   Oct  7 15:18:45 Leonardo-Ferreiras-iMac.local pppd[3385]: pppd 2.4.2 (Apple version 596.15.2) started by leo, uid 501   Oct  7 15:18:45 Leonardo-Ferreiras-iMac.local pppd[3385]: L2TP connecting to server 'vpn.aec.com.br' (186.249.4.10)...   Oct  7 15:18:45 Leonardo-Ferreiras-iMac.local pppd[3385]: IPSec connection started   Oct  7 15:18:46 Leonardo-Ferreiras-iMac.local racoon[192]: Connecting.   Oct  7 15:18:46 Leonardo-Ferreiras-iMac.local racoon[192]: IPSec Phase1 started (Initiated by me).   Oct  7 15:18:46 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Initiator, Aggressive-Mode message 1).   Oct  7 15:18:47 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:18:47 Leonardo-Ferreiras-iMac kernel[0]: Sandbox: sandboxd(3386) deny mach-lookup com.apple.coresymbolicationd   Oct  7 15:18:48 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:49 --- last message repeated 2 times ---   Oct  7 15:18:49 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Phase1 Retransmit).   Oct  7 15:18:50 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:18:50 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:51 --- last message repeated 2 times ---   Oct  7 15:18:51 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:18:52 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:52 --- last message repeated 1 time ---   Oct  7 15:18:52 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Phase1 Retransmit).   Oct  7 15:18:52 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:52 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:18:53 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:54 --- last message repeated 2 times ---   Oct  7 15:18:54 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:18:54 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:55 --- last message repeated 2 times ---   Oct  7 15:18:55 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Phase1 Retransmit).   Oct  7 15:18:55 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local pppd[3385]: IPSec connection failed   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local pppd[3385]: L2TP connecting to alternate server 'vpn.aec.com.br' (200.251.240.177)...   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local pppd[3385]: IPSec connection started   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local racoon[192]: Connecting.   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local racoon[192]: IPSec Phase1 started (Initiated by me).   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Initiator, Aggressive-Mode message 1).   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:56 --- last message repeated 2 times ---   Oct  7 15:18:56 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:18:57 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:18:59 --- last message repeated 2 times ---   Oct  7 15:18:59 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Phase1 Retransmit).   Oct  7 15:19:00 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:19:00 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:19:01 --- last message repeated 2 times ---   Oct  7 15:19:01 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:19:02 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Phase1 Retransmit).   Oct  7 15:19:03 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:19:03 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:19:05 --- last message repeated 2 times ---   Oct  7 15:19:05 Leonardo-Ferreiras-iMac.local com.apple.quicklook.satellite[3358]: [QL] No sandbox token for thumbnail request file://localhost/private/var/log/racoon.log, it will probably fail   Oct  7 15:19:05 Leonardo-Ferreiras-iMac.local racoon[192]: IKE Packet: transmit success. (Phase1 Retransmit).   Oct  7 15:19:05 Leonardo-Ferreiras-iMac.local sandboxd[3386] ([3358]): QuickLookSatelli(3358) deny file-read-data /private/var/log/racoon.log   Oct  7 15:19:06 --- last message repeated 2 times ---   Oct  7 15:19:06 Leonardo-Ferreiras-iMac.local pppd[3385]: IPSec connection failed   Oct  7 15:19:06 Leonardo-Ferreiras-iMac.local racoon[192]: IPSec disconnecting from server 200.251.240.177   Oct  7 15:19:06 Leonardo-Ferreiras-iMac.local racoon[192]: IPSec disconnecting from server 186.249.4.10   /code/pre  Second: The Windows 7 VPN manual (the only one available) states that I should check the box "CHAP Protocol" &amp; "CHAP v2" and I must select the option where encryption is required.  Third: I must also enter the pre-shared-key, which I deduce is the shared-secret option of mountain lion.  Still no luck at all… can anyone help?  strongEDIT 1:/strong The dump file is here  <answer105349> ol liMake sure that strongBack to My Mac/strong is emdisabled/em under strongSystem Preferences/strong → strongiCloud/strong./li liThere are certain characters that OS X does not like in shared secrets. Make sure that your shared secret…  ul liis shorter than 64 characters in length/li lidoes not contain code'/code (apostrophe)/li lidoes not contain code′/code, code″/code or code‴/code (prime, double prime or triple prime)/li /ul/li liAllow access to your key stored in Keychain Access:  ol liOpen strongKeychain Access/strong (code/Applications/Utilities//code)/li liSelect the strongSystem/strong keychain on the top-left list of keychains.  img src="https://i.stack.imgur.com/D8MNw.png" width="150"/li liFind the certificate relating to your VPN server and click the disclosure triangle to the left of it to show the strongPrivate Key/strong (should have a key icon).  img src="https://i.stack.imgur.com/CBGbd.png" width="400"/li liDouble-click it to open the Private Key properties, and select the strongAccess Control/strong tab./li liSelect strongAllow all applications to access this item/strong./li liClick strongSave Changes/strong and enter your administrator password./li /ol/li /ol  <answer105394> It seems odd that your machine is attempting to use aggressive-mode in phase 1 of the IPSec connection. From what I can see, the default in 10.8.5 is to use main-mode. I'm wondering if you've modified the file at code/etc/racoon/racoon.conf/code in trying to get this working? Can you post the contents of the file at code/etc/racoon/racoon.conf/code?  Alternately, it may be possible to duplicate the configuration file that the L2TP/IPSec connection in System Preferences is using, and modify it slightly (configure to use main-mode) to see if that helps. Unfortunately, that configuration file is created at connect time, and is copied into /var/run/racoon/fqdn.of.host.conf. This file is also readable only by root (to protect the PSK that's stored inside of it). If you're quick, you can prepare a Terminal command that will copy that config file, initiate the VPN connection from System Preferences or the menu bar, and perform the copy command emwhile the VPN is attempting to connect/em (you may have 5-10 seconds to perform the copy). Here's the command that you'd run right after initiating the VPN connection:  precodesudo cp -Rp /var/run/racoon/vpn.aec.com.br ~/Desktop /code/pre  That file has permissions that disallow users from reading it. Use the command to make it readable:  precodesudo chmod 777 ~/Desktop/vpn.aec.com.br /code/pre  emstrongNOTE: the file that you've copied onto the Desktop contains your PSK. You should not post this file (unmodified) to this website. If you would like to post this configuration file for troubleshooting, obfuscate the value of codeshared_secret/code before posting./em/strong  You can configure the VPN connection to use main-mode by modifying the configuration file that you've copied onto your Desktop. Open that file in any text editor, and locate the line that says codeexchange_mode/code. You may find that it says something like:  precodeexchange_mode aggressive; /code/pre  If so, see if you can change it so that it uses main-mode:  precodeexchange_mode main; /code/pre  Next, disable the built-in launchd script that launches coderacoon/code normally:  precodesudo launchctl unload /System/Library/LaunchDaemons/com.apple.racoon.plist /code/pre  Then, you can temporarily launch coderacoon/code, and instruct it to use the configuration file that you exported:  precodesudo racoon -f ~/Desktop/vpn.aec.com.br -l /var/log/racoon.log /code/pre  The racoon process will run in the background using the configuration file that you copied onto the Desktop. The process will also output to code/var/log/racoon.log/code Next, you can initiate a VPN connection using racoonctl:  precodesudo racoonctl vpn-connect vpn.aec.com.br /code/pre  The VPN menubar item will not update while this process is connecting. However, you should see output in code/var/log/system.log/code and in code/var/log/racoon.log/code that reflects the fact that the IPSec Phase 1 connection is moving along (i.e., Main Mode Message 2, 3, 4, etc.). If you see that the machine is able to establish the IPSec tunnel (look for "IPSec Phase1 established" in codesystem.log/code), you're likely having problems with the exchange_mode that's configured.  strongHow to undo this configuration/strong  To put things back to the way that they were, you can disconnect (if the connection was successful) and then terminate the coderacoon/code process that's running:  precodesudo racoonctl vpn-disconnect  sudo killall racoon /code/pre  Then, re-load the codelaunchd/code config for coderacoon/code:  precodesudo launchctl load -w /System/Library/LaunchDaemons/com.apple.racoon.plist /code/pre  strongHow to make this configuration permanent/strong  If the coderacoon/code configuration file that you used in the tests above seems to be allowing phase 1 to complete, you can configure coderacoon/code to use that config file in the future:  Copy the config file that is on your Desktop into the folder /etc/racoon:  precodesudo cp ~/Desktop/vpn.aec.com.br.conf /etc/racoon/vpn.aec.com.br.conf /code/pre  Make sure to secure the permissions on that file:  precodesudo chmod 600 /etc/racoon/vpn.aec.com.br.conf /code/pre  Comment out the last line of the file at code/etc/racoon/racoon.conf/code, and add a line that will load the configuration that you copied to code/etc/racoon/code in the step above:  precodeinclude "/var/run/racoon/*.conf" ; /code/pre  Should be changed to:  precode#include "/var/run/racoon/*.conf" ; include "/etc/racoon/vpn.aec.com.br.conf" ; /code/pre  After you've made this change, you can save the file and attempt the VPN connection again from the menu bar.  <comment123871> no luck... "Back to My Mac" was activated, but clearing it did not solved it... the secret does contains specials chars but they are '*','$' and '+'... the logs remain the same... <comment123876> well, there are no certificates that match my vpn... all I have is "IPSec Shared Secret"... no certificates... anyway, I allowed every one to access it but it did not get me through... logs remain the same <comment123884> Are you using the built-in Windows VPN client to connect (i.e., did the instructions resemble those on this page:http://helpdesk.princeton.edu/kb/display.plx?ID=9987 ?) <comment123888> @EddieKelley yes... looks a lot like that... I only have to set the shared key... <comment123896> A packet capture of the traffic going between your machine and the VPN gateway may help us to diagnose the issues. You can use a Terminal command to capture that traffic into a file in your home directory named "dump.pcap": `sudo tcdump -w ~/dump.pcap host vpn.aec.com.br`. Start that command in Terminal, then attempt the VPN connection (and allow it to timeout). You can signal the `tcpdump` process with an interrupt (Control+C) to kill the packet trace. After the connection fails, you can post the capture file here for evaluation. <comment123906> @EddieKelley ok! i edited the question... i dont know if i captured the right dump though... your command was invalid... so i used "sudo tcpdump -i en0 -s 0 -B 524288 -w ~/Desktop/DumpFile01.pcap" <comment123908> My apologies - that should have been `sudo tcpdump -w ~/dump.pcap host vpn.aec.com.br`...The dump you performed definitely worked, but isn't providing any additional information. The packet trace shows your machine initiating and retrying the Phase 1 IPSec connection several times for each of the hosts, but is not receiving any response from the machines on the other side. <comment123916> well... "Oct 15 22:25:18 Leonardo-Ferreiras-iMac.local racoon[27389]: IPSec Phase1 established (Initiated by me)."... is that a good thing? <comment123920> It seems to be...This indicates that your machine should be using main mode when connecting to the VPN (or at least you're getting further than you were with aggressive mode). As far as how to enable main mode in the configuration - it should be generating a config file with that information...I"m assuming that the file you copied from `/var/run/racoon` had aggressive mode set? Is the L2TP/IPSec VPN interface that you have created in System Preferences one that was carried over from an old machine? It might help to remove and re-add that VPN interface or create a new network location? <comment123922> yes, aggressive mode was set. I already re-created the VPN from scratch a couple of times... every-time aggressive mode comes back on... when using the command line: How can i know that the VPN is up? will i get a "connected" or something? <comment123923> i add the ",base" to the exchange and i got a "VPN connexion established" but i dont think that it means what i think it means... or maybe some config is missing... because, for example, i cant ping my machine based on its name... <comment123925> Can you clarify what you mean by "i add the ",base" to the exchange"? Note: the steps using `racoon` above are only for troubleshooting the phase 1 connection. You should undo the setup as described at the end of the article to restore the normal function of `racoon`. Once you've restored the configuration, it will still be necessary to figure out how to get OS X to create the correct configuration files. It's possible that removing the file at `/Library/Preferences/SystemConfiguration/preferences.plist` may help, but I have not confirmed where that configuration is being generated from. <comment123952> in the racoon config file, i set the exchange_mode to "main,base"... after all that just got mt passed phase 1... in phase 2 the connection fails logging: "notification message 18:INVALID-ID-INFORMATION, doi=1 proto_id=3 spi=0c133028(size=4)." in the "racoon.log" file <comment124017> I've added information on how to configure the modified .conf file to be used permanently.