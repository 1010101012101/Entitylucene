How to fix hang during shutdown of OSX Sierra <body> My MacBook Pro Retina 15-inch Early 2013, running Sierra 10.12.6 has a long standing issue where everytime I reboot (for many months now), it hangs during shutdown with a spinning icon near end of shutdown process that remains stuck spinning even if I let it run overnight.  Upon forced power off and restart, I get the following report:  precodeAnonymous UUID:       77844606-CC97-41AA-EDF6-B18C43EFEB66  Tue Aug 15 16:27:38 2017  *** Panic Report *** Panic(CPU 2): NMIPI for spinlock acquisition timeout, spinlock: 0xffffff8024e67180, spinlock owner: 0xffffff804a484288, current_thread: 0xffffff804a484288, spinlock_owner_cpu: 0x2 RAX: 0x0000000bc38babab, RBX: 0xffffff804a484288, RCX: 0x0000000000000260, RDX: 0x0000000b00000000 RSP: 0xffffff82031bb870, RBP: 0xffffff82031bb8b0, RSI: 0xffffff804a484288, RDI: 0xffffff8024e67180 R8:  0xffffff80248084ec, R9:  0x0000000000000000, R10: 0x0000000000000010, R11: 0x0000000000000010 R12: 0x0000000000000001, R13: 0xffffff804a484288, R14: 0x0000000bc38c178e, R15: 0xffffff8024e67180 RFL: 0x0000000000000097, RIP: 0xffffff80246f7942, CS:  0x0000000000000008, SS:  0x0000000000000000 Backtrace (CPU 2), Frame : Return Address 0xffffff82031bb710 : 0xffffff80247fd781  0xffffff82031bb770 : 0xffffff802469a8bf  0xffffff82031bb8b0 : 0xffffff80247f5683  0xffffff82031bb8d0 : 0xffffff8024c62417  0xffffff82031bbcf0 : 0xffffff80246fc81e  0xffffff82031bbd90 : 0xffffff80248084ec  0xffffff82031bbdd0 : 0xffffff8024807913  0xffffff82031bbe40 : 0xffffff802480743d  0xffffff82031bbf50 : 0xffffff802480628b  0xffffff82031bbf70 : 0xffffff80247fd781  0xffffff82031bbfd0 : 0xffffff802469a759  0xffffff921157b990 : 0xffffff802473013f  0xffffff921157b9e0 : 0xffffff8024b9e3b2  0xffffff921157ba10 : 0xffffff8024b9895a  0xffffff921157ba40 : 0xffffff802494926f  0xffffff921157baa0 : 0xffffff80249546d3  0xffffff921157bb10 : 0xffffff8024b5c340  0xffffff921157bbe0 : 0xffffff8024b5bc35  0xffffff921157bc70 : 0xffffff8024b5a700  0xffffff921157bdb0 : 0xffffff8024b5cbc6  0xffffff921157be00 : 0xffffff7fa53217c0  0xffffff921157bf50 : 0xffffff7fa5321dee  0xffffff921157bfb0 : 0xffffff80246978f7        Kernel Extensions in backtrace:          com.apple.kec.pthread(1.0)[225C22A5-813D-3651-9C40-FDEEAB0D78E1]@0xffffff7fa531e000-&gt;0xffffff7fa532cfff  BSD process name corresponding to current thread: logd  Mac OS version: 16G29  Kernel version: Darwin Kernel Version 16.7.0: Thu Jun 15 17:36:27 PDT 2017; root:xnu-3789.70.16~2/RELEASE_X86_64 Kernel UUID: D3314D98-5D40-3CD8-98A4-F1DD46C20E03 Kernel slide:     0x0000000024400000 Kernel text base: 0xffffff8024600000 __HIB  text base: 0xffffff8024500000 System model name: MacBookPro10,1 (Mac-C3EC7CD22292981F)  System uptime in nanoseconds: 14586799298 last loaded kext at 10586560062: com.intel.kext.intelhaxm   1.1.1 (addr 0xffffff7fa7e57000, size 126976) loaded kexts: com.intel.kext.intelhaxm    1.1.1 com.intel.driver.EnergyDriver   2.0 com.apple.driver.AppleHWSensor  1.9.5d0 com.apple.filesystems.autofs    3.0 com.apple.driver.AudioAUUC  1.70 com.apple.driver.X86PlatformShim    1.0.0 com.apple.driver.ApplePlatformEnabler   2.7.0d0 com.apple.driver.AGPM   110.23.17 com.apple.driver.AppleMikeyHIDDriver    131 com.apple.driver.AppleGraphicsDevicePolicy  3.14.49 com.apple.driver.AppleMikeyDriver   279.48 com.apple.driver.AppleHDAHardwareConfigDriver   279.48 com.apple.driver.pmtelemetry    1 com.apple.driver.AppleHDA   279.48 com.apple.iokit.IOUserEthernet  1.0.1 com.apple.driver.AppleUpstreamUserClient    3.6.4 com.apple.iokit.IOBluetoothSerialManager    5.0.5f1 com.apple.Dont_Steal_Mac_OS_X   7.0.0 com.apple.GeForce   10.1.7 com.apple.driver.AppleHV    1 com.apple.driver.AppleIntelHD4000Graphics   10.2.5 com.apple.driver.AppleThunderboltIP 3.0.8 com.apple.driver.AppleOSXWatchdog   1 com.apple.driver.ACPI_SMC_PlatformPlugin    1.0.0 com.apple.driver.AppleBacklight 170.9.20 com.apple.driver.AppleSMCPDRC   1.0.0 com.apple.driver.AppleSMCLMU    208 com.apple.driver.AppleLPC   3.1 com.apple.driver.AppleMuxControl    3.14.49 com.apple.driver.AppleIntelFramebufferCapri 10.2.5 com.apple.nvidia.NVDAStartup    10.1.7 com.apple.driver.AppleFIVRDriver    4.1.0 com.apple.driver.AppleIntelSlowAdaptiveClocking 4.0.0 com.apple.driver.AppleMCCSControl   1.3.4 com.apple.iokit.IOBluetoothUSBDFU   5.0.5f1 com.apple.driver.AppleUSBTCKeyEventDriver   252 com.apple.driver.AppleUSBTCButtons  252 com.apple.driver.AppleUSBTCKeyboard 252 com.apple.driver.AppleFileSystemDriver  3.0.1 com.apple.AppleFSCompression.AppleFSCompressionTypeDataless 1.0.0d1 com.apple.AppleFSCompression.AppleFSCompressionTypeZlib 1.0.0 com.apple.BootCache 40 com.apple.filesystems.hfs.kext  366.70.1 com.apple.driver.AirPort.Brcm4331   800.20.26 com.apple.iokit.IOAHCIBlockStorage  295.20.1 com.apple.driver.AppleSDXC  1.7.6 com.apple.iokit.AppleBCM5701Ethernet    10.2.10 com.apple.driver.AirPort.Brcm4360   1150.12.1a1 com.apple.driver.AppleAHCIPort  326.60.1 com.apple.driver.AppleSmartBatteryManager   161.0.0 com.apple.driver.AppleACPIButtons   5.0 com.apple.driver.AppleRTC   2.0 com.apple.driver.AppleHPET  1.8 com.apple.driver.AppleSMBIOS    2.1 com.apple.driver.AppleACPIEC    5.0 com.apple.driver.AppleAPIC  1.7 com.apple.driver.AppleIntelCPUPowerManagementClient 219.0.0 com.apple.nke.applicationfirewall   172 com.apple.security.quarantine   3 com.apple.security.TMSafetyNet  8 com.apple.driver.AppleIntelCPUPowerManagement   219.0.0 com.apple.kext.triggers 1.0 com.apple.driver.DspFuncLib 279.48 com.apple.kext.OSvKernDSPLib    525 com.apple.iokit.IOSerialFamily  11 com.apple.driver.AppleSSE   1.0 com.apple.nvidia.driver.NVDAGK100Hal    10.1.7 com.apple.nvidia.driver.NVDAResman  10.1.7 com.apple.iokit.IOSurface   159.9 com.apple.driver.IOPlatformPluginLegacy 1.0.0 com.apple.driver.AppleHDAController 279.48 com.apple.iokit.IOHDAFamily 279.48 com.apple.iokit.IOAudioFamily   205.15 com.apple.vecLib.kext   1.2.0 com.apple.driver.AppleSMBusPCI  1.0.14d1 com.apple.driver.AppleBacklightExpert   1.1.0 com.apple.iokit.IONDRVSupport   516.1 com.apple.driver.AppleGraphicsControl   3.14.49 com.apple.driver.X86PlatformPlugin  1.0.0 com.apple.driver.IOPlatformPluginFamily 6.0.0d8 com.apple.iokit.IOAcceleratorFamily2    311.14 com.apple.AppleGraphicsDeviceControl    3.14.49 com.apple.iokit.IOSlowAdaptiveClockingFamily    1.0.0 com.apple.driver.AppleSMC   3.1.9 com.apple.driver.AppleSMBusController   1.0.18d1 com.apple.iokit.IOGraphicsFamily    515.3 com.apple.driver.AppleThunderboltEDMSink    4.1.1 com.apple.driver.AppleThunderboltDPOutAdapter   5.0.2 com.apple.iokit.IOSCSIArchitectureModelFamily   394.50.1 com.apple.iokit.BroadcomBluetoothHostControllerUSBTransport 5.0.5f1 com.apple.iokit.IOBluetoothHostControllerUSBTransport   5.0.5f1 com.apple.iokit.IOBluetoothHostControllerTransport  5.0.5f1 com.apple.iokit.IOBluetoothFamily   5.0.5f1 com.apple.driver.AppleUSBMultitouch 258 com.apple.driver.usb.IOUSBHostHIDDevice 1.1 com.apple.driver.usb.cdc    5.0.0 com.apple.driver.usb.networking 5.0.0 com.apple.driver.usb.AppleUSBHostCompositeDevice    1.1 com.apple.driver.usb.AppleUSBHub    1.1 com.apple.filesystems.hfs.encodings.kext    1 com.apple.driver.AppleThunderboltDPInAdapter    5.0.2 com.apple.driver.AppleThunderboltDPAdapterFamily    5.0.2 com.apple.driver.AppleThunderboltPCIDownAdapter 2.1.3 com.apple.driver.AppleXsanScheme    3 com.apple.driver.AppleThunderboltNHI    4.5.4 com.apple.iokit.IOThunderboltFamily 6.5.7 com.apple.iokit.IOEthernetAVBController 1.0.3b4 com.apple.iokit.IO80211Family   1200.12.2 com.apple.driver.mDNSOffloadUserClient  1.0.1b8 com.apple.iokit.IONetworkingFamily  3.2 com.apple.driver.corecapture    1.0.4 com.apple.driver.AppleUSBMergeNub   900.4.1 com.apple.iokit.IOAHCIFamily    288 com.apple.driver.usb.AppleUSBEHCIPCI    1.1 com.apple.driver.usb.AppleUSBEHCI   1.1 com.apple.driver.usb.AppleUSBXHCIPCI    1.1 com.apple.driver.usb.AppleUSBXHCI   1.1 com.apple.driver.usb.AppleUSBHostPacketFilter   1.0 com.apple.iokit.IOUSBFamily 900.4.1 com.apple.driver.AppleUSBHostMergeProperties    1.1 com.apple.driver.AppleEFINVRAM  2.1 com.apple.driver.AppleEFIRuntime    2.1 com.apple.iokit.IOHIDFamily 2.0.0 com.apple.iokit.IOSMBusFamily   1.1 com.apple.security.sandbox  300.0 com.apple.kext.AppleMatch   1.0.0d1 com.apple.driver.AppleKeyStore  2 com.apple.driver.AppleMobileFileIntegrity   1.0.5 com.apple.driver.AppleCredentialManager 1.0 com.apple.driver.KernelRelayHost    1 com.apple.iokit.IOUSBHostFamily 1.1 com.apple.driver.AppleBusPowerController    1.0 com.apple.driver.DiskImages 444.50.16 com.apple.iokit.IOStorageFamily 2.1 com.apple.iokit.IOReportFamily  31 com.apple.driver.AppleFDEKeyStore   28.30 com.apple.driver.AppleACPIPlatform  5.0 com.apple.iokit.IOPCIFamily 2.9 com.apple.iokit.IOACPIFamily    1.4 com.apple.kec.Libm  1 com.apple.kec.pthread   1 com.apple.kec.corecrypto    1.0 panic(cpu 4 caller 0xffffff8024c62417): "Spinlock acquisition timed out: lock=0xffffff8024e67180, lock owner thread=0xffffff804a484288, current_thread: 0xffffff8049e216f8, lock owner active on CPU 0x2, current owner: 0xffffff804a484288"@/Library/Caches/com.apple.xbs/Sources/xnu/xnu-3789.70.16/osfmk/i386/locks_i386.c:427 Backtrace (CPU 4), Frame : Return Address 0xffffff82031da850 : 0xffffff80246e953c  0xffffff82031da8d0 : 0xffffff8024c62417  0xffffff82031dacf0 : 0xffffff80246fc81e  0xffffff82031dad90 : 0xffffff80248084ec  0xffffff82031dadd0 : 0xffffff8024807913  0xffffff82031dae40 : 0xffffff802480743d  0xffffff82031daf50 : 0xffffff802480628b  0xffffff82031daf70 : 0xffffff80247fd781  0xffffff82031dafd0 : 0xffffff802469a759  0xffffff820cb3b490 : 0xffffff7fa678f1bb  0xffffff820cb3b4c0 : 0xffffff7fa679454c  0xffffff820cb3b530 : 0xffffff7fa6610112  0xffffff820cb3b590 : 0xffffff7fa66199df  0xffffff820cb3b610 : 0xffffff7fa661bb80  0xffffff820cb3b760 : 0xffffff7fa661a099  0xffffff820cb3b7a0 : 0xffffff7fa679682d  0xffffff820cb3b7f0 : 0xffffff7fa664cce1  0xffffff820cb3b900 : 0xffffff7fa664c6f6  0xffffff820cb3b940 : 0xffffff7fa6895ece  0xffffff820cb3b990 : 0xffffff7fa65a7e75  0xffffff820cb3b9e0 : 0xffffff7fa6505d09  0xffffff820cb3ba00 : 0xffffff7fa6506259  0xffffff820cb3ba70 : 0xffffff7fa5a569d4  0xffffff820cb3baa0 : 0xffffff8024cbd76a  0xffffff820cb3bb10 : 0xffffff7fa5a56a3b  0xffffff820cb3bb60 : 0xffffff7fa6504891  0xffffff820cb3bba0 : 0xffffff802497e099  0xffffff820cb3bbf0 : 0xffffff8024972cbd  0xffffff820cb3bcc0 : 0xffffff8024970e06  0xffffff820cb3bda0 : 0xffffff802497697f  0xffffff820cb3bdd0 : 0xffffff8024ba2460  0xffffff820cb3be10 : 0xffffff8024b51c2b  0xffffff820cb3be40 : 0xffffff8024b9c733  0xffffff820cb3bf50 : 0xffffff8024c240f5  0xffffff820cb3bfb0 : 0xffffff802469ad96        Kernel Extensions in backtrace:          com.apple.iokit.IONetworkingFamily(3.2)[6326DB88-5330-3F0C-91F6-D478AB5E7503]@0xffffff7fa5a4e000-&gt;0xffffff7fa5a7afff          com.apple.iokit.IO80211Family(1200.12.2)[1C010821-6A22-3C8C-B396-409023E8A540]@0xffffff7fa649c000-&gt;0xffffff7fa6581fff             dependency: com.apple.driver.corecapture(1.0.4)[C269B594-3CE8-3AC8-AC81-ADDCC1C9074A]@0xffffff7fa646a000             dependency: com.apple.driver.AppleMobileFileIntegrity(1.0.5)[E54425FE-971A-38E2-8F27-82A1B7A3479D]@0xffffff7fa52d8000             dependency: com.apple.kec.corecrypto(1.0)[E3701C61-A548-3181-9F3E-C90DF8327185]@0xffffff7fa522f000             dependency: com.apple.iokit.IONetworkingFamily(3.2)[6326DB88-5330-3F0C-91F6-D478AB5E7503]@0xffffff7fa5a4e000          com.apple.driver.AirPort.Brcm4360(1150.12.1a1)[BB3626FA-A579-348F-AF69-3249DAC7949D]@0xffffff7fa658c000-&gt;0xffffff7fa6d48fff             dependency: com.apple.driver.corecapture(1.0.4)[C269B594-3CE8-3AC8-AC81-ADDCC1C9074A]@0xffffff7fa646a000             dependency: com.apple.driver.mDNSOffloadUserClient(1.0.1b8)[EE4CC064-65B6-3978-9393-C71C74D5BEAA]@0xffffff7fa617a000             dependency: com.apple.iokit.IO80211Family(1200.12.2)[1C010821-6A22-3C8C-B396-409023E8A540]@0xffffff7fa649c000             dependency: com.apple.iokit.IOPCIFamily(2.9)[3E00E7D2-E569-341D-9BE0-34D5DE491825]@0xffffff7fa4f48000             dependency: com   Model: MacBookPro10,1, BootROM MBP101.00EE.B12, 4 processors, Intel Core i7, 2.7 GHz, 16 GB, SMC 2.3f36 Graphics: Intel HD Graphics 4000, Intel HD Graphics 4000, Built-In Graphics: NVIDIA GeForce GT 650M, NVIDIA GeForce GT 650M, PCIe, 1024 MB Memory Module: BANK 0/DIMM0, 8 GB, DDR3, 1600 MHz, 0x80AD, 0x484D5434314753364D465238432D50422020 Memory Module: BANK 1/DIMM0, 8 GB, DDR3, 1600 MHz, 0x80AD, 0x484D5434314753364D465238432D50422020 AirPort: spairport_wireless_card_type_airport_extreme (0x14E4, 0xEF), Broadcom BCM43xx 1.0 (7.21.171.130.1a1) Bluetooth: Version 5.0.5f1, 3 services, 27 devices, 1 incoming serial ports Network Service: Wi-Fi, AirPort, en0 Serial ATA Device: APPLE SSD SD512E, 500.28 GB USB Device: USB 2.0 Bus USB Device: Hub USB Device: FaceTime HD Camera (Built-in) USB Device: USB 2.0 Bus USB Device: Hub USB Device: Hub USB Device: Apple Internal Keyboard / Trackpad USB Device: BRCM20702 Hub USB Device: Bluetooth USB Host Controller USB Device: USB 3.0 Bus Thunderbolt Bus: MacBook Pro, Apple Inc., 23.4 /code/pre  I had the Genius store reinstall my operating system and I recovered my drive from timemachine backup, but problem still remains on every shutdown.  hr  I patched HAXM to the latest version.  After doing that, booting in codesafe mode/code results in a successful shutdown. However, shutting down with codesudo shutdown -h now/code locks up just like a normal shutdown.  hr  I tried a new user with Admin privileges and it got the same hang.  I even tried shutdown from login screen after boot and never having logged in and it also hangs.  hr  Here are the non-Apple signed extensions:  ul liACS6x: Version: 3.1.8/li liATTOCelerityFC8: Version: 2.5.6/li liATTOExpressSASHBA2: Version: 2.4.6/li liATTOExpressSASRAID2: Version: 3.7.1/li liArcMSR: Version: 1.3.7/li liBJUSBLoad: Version: 10.69.0/li liBJUSBMP: Version: 2.9.0 (The oldest one, last modified: 11/21/10)/li liCalDigitHDProDrv: Version: 2.1.2/li liDropbox: Version: 1.8.1/li liEnergyDriver: Version: 2.0/li liHighPointIOP: Version: 4.3.2/li liHighPointRR: Version: 4.3.3/li liJMicronATA: Version: 1.1.6 (The second oldest, last modified: 5/22/12)/li liProlificUsbSerial: Version: 1.6.0/li liPromiseSTEX: Version: 5.2.10/li liSoftRAID: Version: 5.5.2/li liSophosFileProtection: Version: 9.6.51/li liSophosWebProtection: Version: 9.6.50/li lifuse4x: Version: 0.9.2/li liheimdall: Version: 6.0/li /ul  <answer295894> One problem is that you did apparently not test the system before you restored from TimeMachine. The problem is "long standing": Any third party software installed could be the culprit, any kind of strange configuration restored from TimeMachine could be responsible.  Of course, it would be very helpful to roughly know when the problem did spring up or whether the results are any different if you use   precode sudo shutdown -h now /code/pre  That restored backup has very likely re-introduced your problem. Try a fresh, clean install on another drive/partition. A clean shutdown there should exclude any hardware problem.  An old problem I do see carried back in this description is that you have an intel kext not from Apple. That kext is old and problematic if not properly removed/upgraded. And it is apparently involved in this problem as you can see in your panic report:   precodelast loaded kext at 10586560062: com.intel.kext.intelhaxm   1.1.1 /code/pre   To update or uninstall this kext cf. this Intel-page.  <comment372863> could you check your CPU usage next time before shutdown ? <comment372865> did you ever do hardware test, specific the memory test ? <comment373224> @Buscar웃 The genius bar ran their hardware test before reinstalling OS.  CPU appears normal before I begin shutdown, were you asking during?  During shutdown, the Activity Monitor will be quit, so once that happens not sure if I can monitor CPU any further. <comment373396> the reason I was asking about CPU is that your Panic report says it is a problem with CPU ! <comment373683> Does the problem exist when you boot into [Safe Mode](https://support.apple.com/en-us/HT201262)?  Also try doing a clean install (on a USB drive would be fine as it's just for testing). <comment374424> I've updated HAXM to the latest version.  Using `sudo shutdown -h now` results in a hung shutdown too.  Note that a Safe Mode boot makes problem go away with successful shutdown. <comment374425> That that means there is *something* (possibly in your profile) is getting loaded that is hanging the system.  To rule that out, create a new user with admin rights and see if the problem exists there.  If it doesn't, it's something custom to your account, if the problem persists, it's system wide. <comment374427> That seems to point in the direction of yet another migrated kext or the like that is not loaded when using SafeMode to boot. Try to list all the kexts in Apple_MenuAbout_This_macSystem_ReportExtensions and sort them for "Obtained from". Most probable: one not from Apple and old lurks in there. <comment374433> @Allan Question is updated.  New admin user fails too, even never login fails to shutdown. <comment374437> See updated question with info on non-Apple signed extensions and the oldest two. <comment374439> Hm. I do not know them all. Check all of those if they are still needed and if they are uptodate. Try to deinstall as many of them and as much as possible. --#-- But Sophos and fuse4x stick out to me. Sophos seems unnecessary at best and fuse4x is so old (more than 6 years since last update?): is it really loaded at all? If still needed: Upgrade fuse4x to  https://osxfuse.github.io --#-- Try in Terminal a `kextstat`and compare to the list above. This further indicates that a bit too much cruft crept into your new install. <comment374444> Now we know it's system wide.  There's two ways to attack this - 1)  get an inventory of everything you have installed and see if we can find an issue or 2) do a clean install and migrate your data.   I would go with option 2 personally so I can be sure everything is clean going forward.  Make sure you do a Time Machine backup before proceeding.