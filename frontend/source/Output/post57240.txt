How to check what is preventing MBP from graceful shutdown/restart and fix it? [Now with log entries] <body> And hopefully really final edit: After upgrading to Mountain Lion, the issue seems fixed, hopefully permanently.  Final Edit: The problem doesn't happen all the time, sometimes I have to wait several days for it to occur. So it is hard to test under different conditions (i.e. safe mode or with some software disabled) and I've decided that it is not worth spending days truing different conditions in order to on fix this. Graham Perrin's suggestions were the most helpful for finding specific information about restart/reboot issues, not found in the general-purpose logs.  Some log entries are in Edit at the bottom:  Mid-2010 15in MacBook Pro, running OS X 10.7.4. Sometimes when trying to restart or shutdown the machine, it won't work -- the screen turns gray, the spinning wheel shows, but the machine doesn't power down so after several minutes I have to shut down the machine by pressing the power button.   It doesn't happen every time, and I can't relate any software used during the session with the problem. In fact, when testing this, sometimes this would happen when I try to shutdown the machine immediately after starting it.  How to check what is preventing the graceful shutdown/restart? I assume that I have to look in some log files, but I am not sure which ones and what to look for.  Edit: Added the verbose start/shutdown setting in the nvram as suggested by Graham Perrin,  and eventually the machine got stuck on reboot. I saw some verbose entries on the screen and after rebooting found them in in /var/log/launchd-shutdown.log. It appears that WindowServer may have something to do with it. Below is the end of that log file with the first 3 columns removed (the first had some increasing integer numbers, the second had entries of "1" and the third -- "com.apple.launchd"):  precode234 com.apple.WindowServer   Dispatching kevent callback. 234 com.apple.WindowServer   Job has not died after being killed 2 seconds ago. Simulating exit. 234 com.apple.WindowServer   Dispatching kevent callback. 234 com.apple.WindowServer   EVFILT_PROC event for job. 1 com.apple.launchd         KEVENT[0]: udata = 0x107827a90 data = 0x0 ident = 234 filter = EVFILT_PROC flags= 0x0 fflags = NOTE_EXIT 234 com.apple.WindowServer   Reaping 234 com.apple.WindowServer   Simulated exit: &lt;rdar://problem/9359725&gt; 234 com.apple.WindowServer   Exited 22.016701 seconds after the first signal was sent 0 com.apple.WindowServer     Exited while shutdown in progress. Processes remaining: 0/0 0 com.apple.WindowServer   Job was last to exit during shutdown of: System. 0 com.apple.WindowServer    Total rusage: utime 0.000000 stime 0.000000 maxrss 0 ixrss 0 idrss 0 isrss 0 minflt 0 majflt 0 nswap 0 inblock 0 oublock 0 msgsnd 0 msgrcv 0 nsignals 0 nvcsw 0 nivcsw 0 0 com.apple.WindowServer  Closing receive right for com.apple.windowserver.active 0 com.apple.WindowServer  Mach service deleted: com.apple.windowserver.active 0 com.apple.WindowServer  Closing receive right for com.apple.windowserver 0 com.apple.WindowServer   Mach service deleted: com.apple.windowserver 0 com.apple.WindowServer    Removed 1 com.apple.launchd      System: No submanagers left. 1 com.apple.launchd    System: Removing. 1 com.apple.launchd   System: Removing job manager. 1 com.apple.launchd    System: Userspace shutdown finished at: Wed Aug  1 08:53:12 2012 1 com.apple.launchd   System: Userspace shutdown took approximately 22 seconds. 1 com.apple.launchd   VM statistics (now - orig): Free: 28472 Active: -21833 Inactive: -1038 Reactivations: 0 PageIns: 25 PageOuts: 0 Faults: 1654 COW-Faults: 335 Purgeable: -849 Purges: 0 1 com.apple.launchd   System: Stray process at shutdown: PID 234 PPID 1 PGID 234 WindowServer 1 com.apple.launchd       System: About to call: reboot(RB_HALT). /code/pre  <answer57244> Go to Applications - Utilities, and open Console   Take a look at the system.log file, you might be able to find something there.  <answer57287> codepmset -g assertions/code gets a summary of power assertions:  precode$ pmset -g assertions Assertion status system-wide:    PreventUserIdleDisplaySleep             0    CPUBoundAssertion                       0    DisableInflow                           0    ChargeInhibit                           0    PreventSystemSleep                      0    PreventUserIdleSystemSleep              1    ExternalMedia                           1    DisableLowPowerBatteryWarnings          0    EnableIdleSleep                         1    NoRealPowerSources_debug                0    UserIsActive                            0    ApplePushServiceTask                    0  Listed by owning process:   pid 153: [0x00000099012c023b] PreventUserIdleSystemSleep named: "com.apple.audio.'AppleUSBAudioEngine:Apple Inc.:Display Audio:15261930:2,1'.noidlesleep"    pid 19: [0x00000013012c0235] ExternalMedia named: "com.apple.powermanagement.externalmediamounted"  /code/pre  You can see the path of a process with codeps up $pid/code:  precode$ ps up 153 USER          PID  %CPU %MEM      VSZ    RSS   TT  STAT STARTED      TIME COMMAND _coreaudiod   153   0.0  0.2  2475000   6740   ??  Ss   Fri05PM  12:17.71 /usr/sbin/coreaudiod /code/pre  <answer58157> I've used to have this problem and did find a fix that worked for me. Although I'm not directly answering your question (how to check what's causing the problem), it's a fix that might be worth a shot:  ol liNavigate to "Macintosh HD  Library"/li liDelete the folder named "Java"/li liEmpty Trash/li liShut down/li liOnce you run anything Java-related, you will be prompted to reinstall Java, do that./li /ol  After that, shutdown time should improve. Note: I'm still getting slow shutdowns when I shutdown immediately after the system starts, so after you follow the steps and want to test, wait a few minutes after the system starts before shutting down.  <answer58315> Complementing other answers …   hr  h1Observe verbose mode during restart or shut down/h1  Mac OS X: How to start up in single-user or verbose mode  – if you start in verbose mode, then restart or shut down will be similarly verbose.   Hint: if things in verbose mode seem to not progress beyond a certain point, allow maybe five minutes before either:   ul liforcing a restart (Command-Control-power); or /li liforcing a shutdown (press and hold the power key). /li /ul  If a forced restart does not succeed, that could be another clue to the cause of the problem(s).   A related question, albeit not problem-oriented: Can anyone interpret verbose shutdown messages?  The problem-oriented case here should be easier to resolve for lupincho. Fewer tea leaves.   h2To start in verbose mode without keying Command-V/h2  A preference can be stored in NVRAM. Enter the following command in Terminal, and be prepared to enter your admin password:   precodesudo nvram boot-args="-v" /code/pre  The next start of the system will be verbose.   hr  h1sysdiagnose/h1  Before each restart or shutdown, in Terminal:   precodesudo sysdiagnose /code/pre  It's time consuming, but you need not investigate the results of all runs. Pay attention only if a problems arises.   For a case such as lupincho's:   ul lithe run of codesysdiagnose/code may reveal a problem embefore/em a restart or shut down/li lithe end result of sysdiagnose may be of interest emfollowing/em a emforced/em restart or shut down. /li /ul  More specifically: if a run of codesysdiagnose/code fails to progress beyond a certain point, knowing that point can help to gain a sense of the underlying problem.   During the run you can use the following key combination, repeatedly, to see whether things are progressing:   ul liControl-T/li /ul  For the codeallmemory/code part of the codesysdiagnose/code routine, Apple's two minute estimate may be wildly inaccurate. Be patient.   If you suspect that codesysdiagnose/code fails to progress beyond a certain point, then key:   ul liControl-C/li /ul  If repeated use of Control-C fails to abort codesysdiagnose/code, then (in my experience with Mountain Lion) it's almost certain that an attempt to restart or shut down the operating system will fail.   hr  h1Shutdown monitoring/h1  In Finder, go to:   code/private/var/log/shutdown_monitor.log/code  This file is typically empty, but may contain items of interest following a problematic shutdown. (I have little experience in this area.)  h2If the only stray process at shutdown is WindowServer/h2  It's not unusual to have stray processes at shutdown. A stray can be problematic only if it is not killed.   If you suspect that WindowServer is not killed, and that this particular stray is contributory to shutdown failure: ask yourself whether any third party software makes nonstandard use of the WindowServer process.   Quick Look of a GrabFS view of WindowServer on Mountain Lion, with two displays:   img src="https://i.stack.imgur.com/DuTNX.png" alt="enter image description here"  If Lion is similar, then my gut feeling is that the cause of shutdown failures lies beyond WindowServer.   hr  h1Guesswork, based upon results of launchctl/h1  Whilst the machine is running normally, what response to the following command?   precodesudo launchctl list | grep  --invert-match com.apple /code/pre  Wonder whether any non-Apple software is contributory to the problem. Anti-virus, anti-malware software?  hr  h1Following an upgrade from Lion to Mountain Lion/h1  Aim for:   precode/private/var/log/com.apple.launchd/launchd-shutdown.system.log /code/pre  It seems the default is one log per shut down, with a maximum of two so there's also:   precode/private/var/log/com.apple.launchd/launchd-shutdown.system.log.1 /code/pre  Following any strongforced/strong restart or forced shut down, you might choose to strongset aside a copy/strong of the most recent of the two. If force is required on any more than one occasion, you can compare files to see whether a pattern emerges.   h2Generally/h2  Don't rule out the possibility of an issue with third party software, even release quality. Little Snitch may be well written and widely respected but:   ul liwhen problems such as the one in this question become extended or too puzzling, strongany/strong non-Apple kernel extension deserves attention. /li /ul  I tested Build 12A269 of OS X 10.8 for around two weeks before it was released, with particular attention to strongshut down behaviours in difficult situations/strong. Whilst I have not watched any videos from WWDC 2012, I do have a sense that Apple has worked very hard to strongprevent the need for force/strong in all but the most difficult situations.   h2Building upon David DelMonte's answer/h2  At least on Mountain Lion, I see the strongload of Little Snitch 3.0 Preview 2 (3857) very early – before shutdown logging begins/strong. If things relating to this KEXT are similarly late around shutdown time, then maybe an issue will be not evident in the usual log files on disk.   hr  If ever you discover the cause of the problem – with either Lion or Mountain Lion – I'll be pleased to know.   In the meantime, with big thanks for the bounty, a closing thought:   precodekextstat -l | grep --invert-match com.apple /code/pre  <answer58326> ol liDo you have any peripheral equipment connected (USB, FW, etc)?/li /ol  If so, it would be interesting to disconnect everything and see if the problem exists.  ol liHave you tried repairing permissions, and checking file integrity?/li /ol  Hope these help.  <answer58692> Some more ideas:  ol liCreate another user account. Log in only as this test account. If you don't have the problem, it's likely to be something in your user software. If you do have the problem, it's possible it could be hardware./li liTry to recreate the problem just using battery power./li liFollow the steps for Apple's System Management controller -/li /ol  Resetting the System Management Controller (SMC) Resetting the SMC on Mac portables with a battery you can remove  Shut down the computer. Disconnect the MagSafe power adapter from the computer, if it's connected. Remove the battery. Press and hold the power button for 5 seconds. Release the power button. Reconnect the battery and MagSafe power adapter. Press the power button to turn on the computer.  <answer59052> I didn't realize you had Little Snitch running. I just solved a similar issue for a friend, by removing LS. I suggest you try that. To remove properly, download the LS installer again. Run the installer, but select uninstall.  I'm curious too why you would want to use this app..  <answer152887> My girlfriend had merely deleted the directories for parallels by dragging and dropping the dir to the trash can and emptying trash.  However, I found parallels again within the Library folder, and there was a shell script (.sh file) to uninstall it properly.  This worked and solved our long boot problems.  I mention this because parallels is a known cause of many slow boots and it appears it's not as easy to uninstall as their website indicates (just dragging and dropping the dir).   Happy trails, hope this helps somebody.  <comment65732> I don't see anything strange there. <comment65779> Good answer by Revolver. +1. Could you copy and paste into your question, the system.log entries that you see after you request a shutdown - and maybe a few minutes before.. Paste them into your original question.. <comment65836> I went over system.log several times in the past and didn't find anything unusual compared to graceful shutdowns. Will wait for the next time when this happens and will check the logs again. I should've clarified that I am aware of the general purpose logs, will update that in my original post. <comment65837> I run it and shows nothing. The problem is that after I initiate shutdown/restart I can't run any commands. Also the issue doesn't appear always, so I would have to check this frequently, or write a script to save the info in a file so that after a problematic shutdown/restart I can get back to that file and see if anything showed up. But that seems like a good starting point, thanks a lot! <comment66937> That's interesting; did that, let's see what happens. The issue is that it doesn't happen every time, so the only way to verify is to wait several days and if it doesn't happen again, this may mean that it is fixed. <comment67003> It didn't work, just got a problem shutting down the machine. <comment67034> Thanks, enabled the verbose mode with the nvram command. However, even after restarting there is no shutdown_monitor.log. There are files launchd-shutdown.log and launchd-shutdown.log.1 (it seems that only the current and 1 previous of these are kept, unlike other logs), but these were there before and I looked at them previously. I will be checking the verbose mode shutdown messages, hopefully I could see where the shutdown/restart gets stuck. <comment67038> If a problem recurs, take a photo or two of the verbosity. Don't worry too much about focus etc., I'll recognise key points even with some blur. I have a hunch about what's wrong in your case, the new `sysdiagnose` part of this answer may be most relevant. <comment67042> Side note: here with Mountain Lion I have `/private/var/log/kernel-shutdown.log` (with information that is useful to me) but not `/private/var/log/launchd-shutdown.log`. <comment67044> Thanks for the 'sysdiagnose' hint, just run it, went fine, will try it again. As you said, it takes some time, otherwise I could put it in logout hook to run every time. <comment67045> Connect any normally used disks, make any normally used file server connections, then please run the `mount` command. Including the result in your question might help to narrow things down. <comment67046> Automation is tempting, but I should refrain from making `sysdiagnose` a logout item. In an edge case, the automation could make a difficult situation worse. <comment67052> There are no normally used disks or file server connections, I am connecting USB drives couple of times per month, but I don't have any to try right now. I did run 'mount' without any disk connected, but there is nothing fishy. <comment67060> I did repair permissions. No peripherals, not even an ethernet cable.  Will add that info to the question. <comment67899> No antivirus or antimalware software; just Little Snitch. The output from that launchctl command shows Apple software - 0 com.microsoft.office.licensing.helper; - 0 com.adobe.fpsaud; 68 - at.obdev.littlesnitchd <comment67965> Please, which version of Little Snitch? Is the problem reproducible with safe boot, or without Little Snitch? <comment67996> The latest stable LS (2.5.3), not the preview of version 3. But this was happening with previous 1-2 versions too. I can't reasonably test this without LS or in safe mode, as this doesn't happen all the time, sometimes it takes days to happen and I can't run the machine like that for extended periods of time. I guess, I would live with this for now, and will upgrade to Mountain Lion and see what happens. But your suggestions were most helpful and specific, thus you get the bounty. <comment68016> Thanks! Based on your plan to upgrade the OS, I added a section to my answer. The **shortest answer** now is that compared to 10.7.4, 10.8 should be both (a) less likely to require force; and (b) easier to diagnose in case of force. <comment68017> Voted up primarily for your idea (1). For idea (2), with the symptoms as currently described, personally I wouldn't suspect any difference with battery power alone. However problems such as lupincho's *are* surprisingly difficult to diagnose without direct access … so it's not a bad idea. Idea (3), problems solved by a reset are (to me) extremely rare … but again it's not a bad idea – quick and simple to perform so this, too, gains my vote. <comment68019> Peripherals – always good to consider when (as in lupincho's question) there's a scent of an issue with I/O. Permissions – IMHO never likely to prevent a shut down of the OS. Disintegration – possible, but to me the question in its current form smells more of an issue with software. (Side note, on integrity: [What free or open source software can I use with Mac hardware to verify integrity of every block of a disk where Core Storage is used?](http://apple.stackexchange.com/q/57869/8546) – too much technobabble there at the moment, eventually it should condense to something much simpler.) <comment68054> Not yet in the question, [Little Snitch was first mentioned in (more) commentary](http://apple.stackexchange.com/questions/57240/how-to-check-what-is-preventing-mbp-from-graceful-shutdown-restart-and-fix-it/58692#comment67899_58315) to an answer. <comment68058> Please: did your friend's computer run Lion, or Mountain Lion? Which version of Little Snitch was uninstalled? <comment68061> That was Lion. I do not know the LS version.. sorry. <comment68068> There is no proof that LS is causing that and unfortunately, because the problem doesn't occur every time, testing this with LS removed would take several days during which I can't lose LS. As for the reason for running LS: there are too many programs phoning home and it's just another level of control for outgoing traffic. What I would eventually do is to upgrade to version 3 when it is officially released. <comment68246> For troubleshooting purposes, Little Snitch may be treated differently from other third party KEXTs for at least two reasons: (i) the earliness of its load, and (ii) its placement in the System domain at `/System/Library/Extensions`. With credit to David I added a section to my answer.